{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management System</title>
    {% comment %}
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    {% endcomment %}

    <!-- Link to static CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %" />
    <script src="{% static 'js/script.js' %}"></script>
  </head>

  <body>
    <header>
      <h1>Student Management System</h1>
      <nav>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#students">Students</a></li>
          <li><a href="#add">Add Student</a></li>
        </ul>
      </nav>
    </header>

    <!-- Home Section -->
    <section id="home" class="section">
      <h2>Welcome to Student Management System</h2>
      <button id="btn-login">Login</button>
    </section>

    <!-- ==== SLIDE-IN USER SIDEBAR ==== -->

    {% comment %}
    <button id="side_btn">
      <i
        class="fa-solid fa-bars"
        onclick="openSidePanel()"
        style="font-size: 26px; cursor: pointer"
      ></i>
    </button>
    {% endcomment %}
    <button id="side_btn">@</button>

    <div class="side-panel" id="sidePanel">
      <button class="close-btn" id="closeBtn">&times;</button>

      <h2>Admin</h2>
      <hr />
      <a href="#">Dashboard</a>
      <a href="#">Admin</a>
      <a href="#">Teacher</a>
      <a href="#">Student</a>

      <div class="menu-item" onclick="toggleMenu('academicsMenu',this)">
        <span>Academics</span>
        <span class="arrow">&lt;</span>
      </div>

      <div id="academicsMenu" class="subMenu">
        <a href="#">Class</a>
        <a href="#">Subject</a>
        <a href="#">Assign Subject</a>
        <a href="#">Syllabus</a>
        <a href="#">Class Timetable</a>
        <a href="#">Assign Class Teacher</a>
      </div>

      <a href="#">Fees Collection</a>
      <a href="#">Examinations</a>
      <a href="#">Attendance</a>
      <a href="#">Communicate</a>
      <a href="#">My Account</a>
      <a href="#">Setting</a>
      <a href="#">Change Password</a>
      <a href="#">Logout</a>
    </div>

    <!-- ===== Login Popup ===== -->
    <div id="loginPopup" class="popup-container">
      <div class="popup-box">
        <span class="close-btn" onclick="closePopup('loginPopup')"
          >&times;</span
        >
        <h2>Student Login</h2>

        <form method="POST" action="{% url 'login' %}">
          {% csrf_token %}
          <input
            type="email"
            name="email"
            placeholder="Email"
            id="email"
            required
          />
          <input
            type="password"
            name="password"
            placeholder="Password"
            id="password"
            required
          />

          <!-- Error message hidden initially -->
          {% comment %}
          <p
            id="login_error"
            style="color: red; display: none; margin-left: -20px"
          >
            Password does not match!
          </p>
          {% endcomment %}

          <button onclick="login()" class="popup-btn" type="submit">
            Login
          </button>
        </form>

        {% if login_error %}
        <p style="color: red; margin: 5px 0 10px 0; display: block">
          {{ login_error }}
        </p>
        {% endif %}

        <p><a href="">Forgot Password?</a></p>
        <p>
          <a href="#" onclick="switchPopup('loginPopup','signupPopup')"
            >Register</a
          >
        </p>
      </div>
    </div>

    <!-- ===== Signup Popup ===== -->
    <div id="signupPopup" class="popup-container">
      <div class="popup-box">
        <span class="close-btn" onclick="closePopup('signupPopup')"
          >&times;</span
        >
        <h2>Signup</h2>
        <form method="POST" action="{% url 'signup' %}">
          {% csrf_token %}
          <input
            type="text"
            name="admission_no"
            placeholder="Admission No"
            required
          />
          <input type="text" name="name" placeholder="Full Name" required />
          <input type="email" name="email" placeholder="Email" required />
          <input type="date" name="dob" placeholder="Date of Birth" required />
          <input
            type="tel"
            name="mobile"
            placeholder="Mobile Number"
            required
          />
          <input
            type="password"
            name="password"
            id="signup_password"
            placeholder="Password"
            oninput="checkPassword()"
            required
          />
          <input
            type="password"
            name="confirm_password"
            id="confirm_password"
            placeholder="Confirm Password"
            oninput="checkPassword()"
            required
          />

          <select name="role" required>
            <option value="" disabled selected>Select Role</option>
            <option value="student">Student</option>
            <option value="parent">Parent</option>
            <option value="teacher">Teacher</option>
            <option value="principal">Principal</option>
          </select>

          {% if signup_error %}
          <p
            id="signup_error"
            style="color: red; margin: 5px 0px 20px 25px; display: block"
          >
            {{ signup_error }}
          </p>
          {% endif %}

          <!-- Error message hidden initially -->
          <p id="errorMsg" style="color: red; display: none; margin-left: 25px">
            Incorrect Password!
          </p>

          <button id="signupBtn" type="submit" class="popup-btn" disabled>
            Sign Up
          </button>
        </form>
        <p>
          Already have an account?
          <a href="#" onclick="switchPopup('signupPopup','loginPopup')"
            >Login</a
          >
        </p>
      </div>
    </div>
    <script>

        {% comment %}
        function closePopup(id) {
          document.getElementById(id).style.display = "none";

          // Remove SIGNUP error message
          const err = document.getElementById("signup_error");
          if (err) {
              err.innerHTML = "";
              err.style.display = "none";
          }

          // OPTIONAL: clear the form inputs
          const form = document.querySelector("#" + id + " form");
          if (form) form.reset();
        }

        {% endcomment %}


        {% comment %}
        function closePopup(id) {
          document.getElementById(id).style.display = "none";

          // Remove SIGNUP backend error
          const signupError = document.getElementById("signup_error");
          if (signupError) {
              signupError.innerHTML = "";
              signupError.style.display = "none";
          }

          // Remove LOGIN backend error
          const loginError = document.getElementById("login_error");
          if (loginError) {
              loginError.innerHTML = "";
              loginError.style.display = "none";
          }

          // Reset the form fields inside popup
          const form = document.querySelector("#" + id + " form");
          if (form) form.reset();
        }
        {% endcomment %}



              /* Show panel */
        document.getElementById('side_btn').onclick = function (e)
         {
            e.preventDefault();
           document.getElementById('sidePanel').classList.add('open');
              }

              // Close panel
              document.getElementById('closeBtn').onclick = function () {
                  document.getElementById('sidePanel').classList.remove('open');
              }

              //submenu
              function toggleMenu(id,element){
                  const subMenu=document.getElementById(id);

                  if(subMenu.style.display === 'block'){
                      subMenu.style.display = 'none';
                      element.classList.remove('active');
                  }
                  else{
                      subMenu.style.display = "block"
                      element.classList.add('active');
                  }
              }

        function checkPassword() {
        let password = document.getElementById("signup_password").value;
        let confirm_password = document.getElementById("confirm_password").value;
        let msg = document.getElementById("errorMsg");
        let btn = document.getElementById("signupBtn");

         // Disable button initially
          btn.disabled = true;

        if (confirm_password === "") {
          msg.style.display = "none"; // hide when user has not typed anything
          return;
        }

        if (password === confirm_password) {
          msg.style.display = "none"; // match → hide message
          btn.disabled = false;
        } else {
          msg.style.display = "block"; // mismatch → show message
          btn.disabled = true;
        }
      }

       //  for login and signup display (URL)

        function openPopup(id) {
            document.getElementById(id).style.display = "flex";
          }

         function closePopup(id) {
            document.getElementById(id).style.display = "none";
         }

        function switchPopup(closeId, openId) {
            closePopup(closeId);
            openPopup(openId);
          }

        //  <!-- Django popup trigger -->

        {% if popup == 'login' %}
          window.onload = function ()
          {
            openPopup('loginPopup');
         }
        {% elif popup == 'signup' %}
       window.onload = function ()
        {
            openPopup('signupPopup');
        }
        {% endif %}
      {% comment %}
       function closePopup(id) {
          document.getElementById(id).style.display = "none";

          // Clear signup backend error
          const msg = document.getElementById("signup_errors");
          if (msg) {
              msg.style.display = "none";
          }

          // Clear form fields
          const form = document.querySelector("#" + id + " form");
          if (form) {
              form.reset();
          }
       }  {% endcomment %}

      function clearSignupErrors() {
          let err = document.getElementById("signup_error");
          if (err) {
              err.innerHTML = "";   // remove error message
          }
      }

      function closePopup(id) {
          document.getElementById(id).style.display = "none";

          if (id === "signupPopup") {
              clearSignupErrors();   // clear error only for signup popup
          }
      }
    </script>

    {% if messages %}
    <script>
      {% for message in messages %}
        alert("{{ message }}");
      {% endfor %}
    </script>
    {% endif %}
  </body>
</html>
